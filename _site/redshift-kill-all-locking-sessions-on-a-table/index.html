<!DOCTYPE html>
<!--
    So Simple Jekyll Theme 3.1.1
    Copyright 2013-2019 Michael Rose - mademistakes.com | @mmistakes
    Free for personal and commercial use under the MIT license
    https://github.com/mmistakes/so-simple-theme/blob/master/LICENSE
-->
<html lang="en-US" class="no-js">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta property="og:image" content="http://localhost:4000/assets/RedShift Kill All Locking Sessions On A Table.png">
<script data-ad-client="ca-pub-9518508677792760" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<link rel="apple-touch-icon" sizes="57x57" href="/favicon.ico/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicon.ico/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicon.ico/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicon.ico/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicon.ico/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicon.ico/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicon.ico/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicon.ico/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/favicon.ico/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon.ico/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico/favicon-16x16.png">
<link rel="manifest" href="/favicon.ico/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">  
  

  
    <title>RedShift Kill All Locking Sessions On A Table</title>
    <meta name="description" content="In any relational database, if you didn’t close the session properly, then it’ll lock your DDL queries. It’s applicable to RedShift as well. A few days back ...">
    <link rel="canonical" href="http://localhost:4000/redshift-kill-all-locking-sessions-on-a-table/">
  

  <script>
    /* Cut the mustard */
    if ( 'querySelector' in document && 'addEventListener' in window ) {
      document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + 'js';
    }
  </script>

  <link rel="stylesheet" href="/assets/css/main.css">
  <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  <link rel="stylesheet" href="/assets/css/applause-button.css" />
   <script src="/assets/js/applause-button.js"></script>

</head>


  <body class="layout--post  redshift-kill-all-locking-sessions-on-a-table">
    <nav class="skip-links">
  <h2 class="screen-reader-text">Skip links</h2>
  <ul>
    <li><a href="#primary-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    
  <div class="navigation-wrapper">
    <a href="#menu-toggle" id="menu-toggle">Menu</a>
    <nav id="primary-nav" class="site-nav animated drop">
      <ul><li><a href="/">Home</a></li><li><a href="/posts/">Posts</a></li><li><a href="/categories/">Categories</a></li><li><a href="/tags/">Tags</a></li><li><a href="https://medium.com/@bhuvithedataguy">BigData Articles</a></li><li><a href="/search/">Search</a></li></ul>
    </nav>
  </div><!-- /.navigation-wrapper -->


    <header class="masthead">
  <div class="wrap">
    
    
    
  </div>
</header><!-- /.masthead -->


    <main id="main" class="main-content" aria-label="Content">
  <article class="h-entry">
    
  
  
  

  <div class="page-image">
    <img src="/assets/RedShift%20Kill%20All%20Locking%20Sessions%20On%20A%20Table.png" class="entry-feature-image u-photo" alt="RedShift Kill All Locking Sessions On A Table" style="margin-top: 0;">
    
  </div>


    <div class="page-wrapper">
      <header class="page-header">
        
        
          <h1 id="page-title" class="page-title p-name">RedShift Kill All Locking Sessions On A Table
</h1>
        

      </header>
      
      <div class="page-sidebar">
        <div class="page-author h-card p-author"><div class="author-info"><div class="author-name">
        <span class="p-name">Nitin Kumar Singh</span>
      </div>
    <time class="page-date dt-published" datetime="2019-12-26T05:00:00+05:30"><a class="u-url" href="">December 26, 2019</a>
</time>

  </div>
</div>

        
  <h3 class="page-taxonomies-title">Categories</h3>
  <ul class="page-taxonomies"><li class="page-taxonomy">RedShift</li>
  </ul>


        
  <h3 class="page-taxonomies-title">Tags</h3>
  <ul class="page-taxonomies"><li class="page-taxonomy">aws</li><li class="page-taxonomy">redshift</li><li class="page-taxonomy">sql</li>
  </ul>


        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- ad-vertical -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9518508677792760"
     data-ad-slot="4154399056"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
        <br/>
        <br/>
        <applause-button style="width: 58px; height: 58px; text-align:right" color="black" multiclap="true">

      </div>

      <div class="page-content">
        <div class="e-content">

          <p>In any relational database, if you didn’t close the session properly, then it’ll lock your DDL queries. It’s applicable to RedShift as well. A few days back I got a scenario that we have to run some DROP TABLE commands to create some lookup tables. But every time while triggering this DDL it got stuck. Then we realize there were some sessions that are still open and those sessions are causing this locking. There we 30+ sessions. I know we can fix this by properly closing the session from the application side. But in some emergency cases, we need to kill all open sessions or locking session in Redshift.</p>

<p>Then my DBA brain was telling me to create a stored procedure to get all the locking sessions and kill them in one shot. I never recommend running this all the time. But if you are a DBA or RedShift Admin, then you need to have these kinds of handy toolkits.</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">replace</span> <span class="k">PROCEDURE</span> <span class="n">sp_superkill</span><span class="p">(</span><span class="k">table_name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> 
<span class="k">LANGUAGE</span> <span class="n">plpgsql</span> 
<span class="k">AS</span> 
  <span class="err">$$</span> 
  <span class="k">DECLARE</span> 
    <span class="n">list</span> <span class="n">RECORD</span><span class="p">;</span> 
    <span class="n">terminate_query</span>      <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50000</span><span class="p">);</span> 
    <span class="n">drop_query</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50000</span><span class="p">);</span> 
  <span class="k">BEGIN</span> 
    <span class="k">FOR</span> <span class="n">list</span> <span class="k">IN</span> 
    <span class="k">SELECT</span> <span class="n">a</span><span class="p">.</span><span class="n">datname</span><span class="p">,</span> 
           <span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="p">,</span> 
           <span class="n">a</span><span class="p">.</span><span class="n">procpid</span> 
    <span class="k">FROM</span>   <span class="n">pg_stat_activity</span> <span class="n">a</span> 
    <span class="k">join</span>   <span class="n">pg_locks</span> <span class="n">l</span> 
    <span class="k">ON</span>     <span class="n">l</span><span class="p">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">procpid</span> 
    <span class="k">join</span>   <span class="n">pg_class</span> <span class="k">c</span> 
    <span class="k">ON</span>     <span class="k">c</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">l</span><span class="p">.</span><span class="n">relation</span> 
    <span class="k">WHERE</span>  <span class="k">c</span><span class="p">.</span><span class="n">relname</span><span class="o">=</span><span class="k">table_name</span> 

    <span class="n">LOOP</span> 
    <span class="n">terminate_query</span><span class="p">:</span><span class="o">=</span> <span class="s1">'select pg_terminate_backend('</span><span class="o">||</span><span class="n">list</span><span class="p">.</span><span class="n">procpid</span><span class="o">||</span><span class="s1">')'</span><span class="p">;</span> 
    <span class="n">RAISE</span> <span class="n">info</span> <span class="s1">'Killing pid [%]'</span><span class="p">,</span> <span class="n">list</span><span class="p">.</span><span class="n">procpid</span><span class="p">;</span> 
    <span class="k">EXECUTE</span> <span class="n">terminate_query</span><span class="p">;</span> 
  <span class="k">END</span> <span class="n">LOOP</span><span class="p">;</span> 
  
  <span class="c1">--drop_query:='drop table '||table_name; --Add DDL If you want</span>
  <span class="c1">--EXECUTE drop_query; --Add DDL If you want</span>
<span class="k">END</span><span class="p">;</span> 
<span class="err">$$</span><span class="p">;</span></code></pre></figure>

<h2 id="testing-the-procedure">Testing the Procedure:</h2>

<p>Open multiple sessions for a table and don’t close them.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">START TRANSACTIONS<span class="p">;</span>
Select col1 from my_table limit 1<span class="p">;</span></code></pre></figure>

<p>Do open a few more sessions. Then run the stored procedure.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">call sp_superkill<span class="o">(</span><span class="s1">'my_table'</span><span class="o">)</span><span class="p">;</span>

INFO:  Killing pid <span class="o">[</span>11734]
INFO:  Killing pid <span class="o">[</span>11735]
INFO:  Killing pid <span class="o">[</span>11738]
INFO:  Killing pid <span class="o">[</span>11739]
CALL</code></pre></figure>

        </div>
        <hr>
        <h3>Advertisement</h3>
         <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- ad-horizontal -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9518508677792760"
     data-ad-slot="4874591962"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
        <hr>
        <h3> Share this article </h3>
      
        

        

        <nav class="page-pagination" role="navigation">
  
    <a class="page-previous" href="/monitor-debezium-mysql-connector-with-prometheus-and-grafana/">
      <h4 class="page-pagination-label">Previous</h4>
      <span class="page-pagination-title">
        <i class="fas fa-arrow-left"></i> Monitor Debezium MySQL Connector With Prometheus And Grafana

      </span>
    </a>
  

  
    <a class="page-next" href="/debezium-mysql-snapshot-from-read-replica-with-gtid/">
      <h4 class="page-pagination-label">Next</h4>
      <span class="page-pagination-title">
        Debezium MySQL Snapshot From Read Replica With GTID
 <i class="fas fa-arrow-right"></i>
      </span>
    </a>
  
</nav>

      </div>
    </div>
  </article>
</main>


    <footer id="footer" class="site-footer">
  <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
<div class="copyright">
    
      <p>&copy; 2020 Nitin Kumar Singh | Data Architect. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/mmistakes/so-simple-theme" rel="nofollow">So Simple</a>.</p>
    
  </div>
</footer>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="/assets/js/main.min.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.0.12/js/all.js"></script>


  </body>

</html>
